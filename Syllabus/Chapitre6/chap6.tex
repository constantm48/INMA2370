\ifx \globalmark \undefined %% This is default.
	\input{header}
	\begin{document} %% Crashes if put after (one of the many mysteries of LaTeX?).
\else 
	\documentclass{standalone}
	\begin{document}
\fi

\graphicspath{ {Chapitre6/images/} }

\setcounter{chapter}{5}
\chapter{State transformation}
\chaptermark{State transformation}\label{transetat}


\lettrine[lines=1]{\bf I}{}n the previous chapters, we have shown how the modeling process can be systematized for different classes of systems relating to engineering. For each type of system, a general state model has been established. The state variables in these models have precise physical meaning: positions and speeds for the mechanical systems, currents and tensions for the electrical systems, total amount for the systems with compartments, concentrations, volume and temperature for the reaction systems. However, it’s often helpful to analyze the behavior of a dynamic system to proceed of a state transformation leading to an equivalent model of the system but expressed with new state variables. 
 
In addition to state transformations, it’s also interesting to use graphical depictions to see easily some structural features of the system. Among the most common representations, the \textit{function diagram} and the \textit{graph of the system} defined below will be mentioned.


\section{Function diagram}

The function diagram of a dynamic system is an oriented graph where each node is one of the two function blocks represented at the figure  \ref{Fig:blocfonct}.
\begin{figure}[htbp] 
   \centering
   \includegraphics[width=10cm]{blocfonct} 
   \caption{function blocks: (a) integrator, (b) function}
   \label{Fig:blocfonct}
\end{figure}
\begin{itemize}
\item[$\bullet$] The function block  Fig. \ref{Fig:blocfonct} 
(a) represents an integrator where the input variable is the derivative of the output variable.
\item[$\bullet$] The function block  Fig. \ref{Fig:blocfonct} 
(b) represents a function  $f: \real^p \rightarrow \real$ where the output variable  $z(t)$ is a function of the input variables:
\begin{equation*} \begin{split}
z(t) = f(x_1(t), x_2(t), \dots , x_p(t)).
\end{split} \end{equation*}
\end{itemize}
In some cases, the drawing of this block is particularized in order to make explicit the function which it represents. Three examples are shown in the figure  \ref{Fig:exblocfonct}. The function diagram of a dynamic system contains necessarily $n$ integrators for which the outputs are the $n$ state variables of the system. These integrators are interconnected via function blocks representing the different functions appearing in the state equations. \textcolor{blue}{Function diagram’s arcs are interpreted as instant transmission of variables attached to them.}
\begin{figure}[htbp] 
   \centering
   \includegraphics[height=55mm]{exblocfonct} 
   \caption{examples of function blocks: (a) adder, (b) multiplier, (c) product by a constant.}
   \label{Fig:exblocfonct}
\end{figure}

In addition to their importance for the analyze of the dynamic systems, function diagrams are also a programming fundamental tool in standard languages of dynamic simulation  MATLAB/Simulink or VisSim.

\begin{exemple}{\bf \em Algae in the lagoon (continuation)}

In the previous chapter, we have established a simple model describing the growing process of an algae population in a lagoon. Assuming that the growing kinetic follows a bilinear law  $r(x_1,x_2) = x_1x_2$, this model is written:
\begin{equation*} \begin{split}
\dot x_1 &= -kx_1x_2 + u, \\
\dot x_2 &= x_1x_2 - dx_2.
\end{split} \end{equation*}
The corresponding function diagram is represented at the figure 
\ref{Fig:schema}. \qed
\begin{figure}[htbp] 
   \centering
   \includegraphics[height=75mm]{schema} 
   \caption{Function diagram of the algae growing model}
   \label{Fig:schema}
\end{figure}
\end{exemple}

\section{Graph of a dynamic systeme}

The graph of a dynamic system is, in some way, the complementary graph of the function diagram. Indeed, nodes of the graph contain the state variables $x_i$ and the input variables $u_j$ while (oriented) arcs represent the functional relationship between these variables.
 
The construction’s rules of a graph of a dynamic system are the following:

\begin{enumerate}
\item The graph contains $n + m$ nodes respectively labeled by the $n$ state variables  $x_1, x_2, \dots , x_n$ and the $m$ input variables  $u_1,u_2, \dots , u_m$.
\item There is an oriented arc from $x_i$ to $x_j$ (or from $u_k$ to $x_j$)) if the variable $x_i$ (or $u_k$) appears explicitly in the equation of the derivative of  $\dot x_j$.
\end{enumerate}
\vv

\begin{exemple}{\bf \em DC electrical machine}

We consider the general model of a DC machine presented in chapter 3, section 3.5. It’s a system with four state variables and three input variables whose model state is written:
\begin{equation*} \begin{split}
\dot x_1 &= x_2, \\
\dot x_2 &= J^{-1}( -h(x_2) + K_mx_3x_4 + u_3), \\
\dot x_3 &= L_f^{-1}(-R_fx_3 + u_1 ), \\
\dot x_4 &= L_a^{-1}(-R_ax_4 - K_ex_2x_3 + u_2).
\end{split} \end{equation*} 
\begin{figure}[htbp] 
   \centering
   \includegraphics[height=65mm]{grafmot} 
   \caption{graph of the state model of a DC engine}
   \label{Fig:grafmot}
\end{figure}
The graph of this system is represented at the figure \ref{Fig:grafmot}. \qed
\end{exemple}

The graph of a dynamic system is a tool to verify easily if the considered system has some interesting structural features. We will see an illustration in section \ref{triangulaire} when we will study triangular systems.

\section{State linear transformation}

For a dynamic system  $\dot x = f(x,u)$, a state linear transformation is a linear application  $T : \real^n
\rightarrow \real^n$ which is bijective and transforms the state of the system 
$x \in \real^n$ in a new state  $z \in \real^n$ following the rule:
\eqnn
z = Tx
\eeqnn
where $T$ is a regular $(n \times n)$ matrix.

In the new coordinates  $z$, the system’s state model is transformed as:
\begin{equation*} \begin{split}
\dot z = T \dot x = Tf(x,u)
\end{split} \end{equation*}
Expressing that  $x= T^{-1}z$ we obtain :
\eqnn
\dot z = g(z,u) \hd \text{with} \hd g(z,u) \triangleq T f(T^{-1} z,u).
\eeqnn
In particular, a linear state model  $\dot x = Ax + Bu$
is transformed in another linear model:
\eqnn
\dot z = Fz + Gu \hd
\text{with} \hd F \triangleq TAT^{-1}, \;\;   G \triangleq TB.
\eeqnn

\begin{exemple}{\bf \em DC generator}

At chapter 3 (Section 3.6.) we have established the state model of a DC generator. When the generator rotates at constant speed $\omega$, the state model is linear and is written:
\eqnn
\bpm
\dot x_1\\ \dot x_2 \epm = 
\bpm
- \dfrac{R_s}{L_s} & 0\\ & \vm \\ 
\dfrac{K_e \omega}{L_r} & - \dfrac{R_r + R_L}{L_r} \epm \bpm x_1\\x_2 \epm +
\bpm \dfrac{1}{L_s} \\ \vm \\ 0 \epm u
\eeqnn
where the state variables $x_1$ and $x_2$ represent respectively the stator and rotor current, while the input $u$ is the applied tension to the stator system. 

\textcolor{blue}{We define new state variables $z_1$ and $z_2$ which can be interpreted as magnetic flow $\phi_s$ and $\phi_r$ through the stator and rotor systems respectively:} 
\begin{equation*} \begin{split}
z_1 &= \phi_s = L_s x_1,\\
z_2 &= \phi_r =  L_r x_2 + K_e x_1.
\end{split} \end{equation*}
We see that it’s well a linear state transformation:
\eqnn
T = \bpm
L_s & 0\\ K_e & L_r \epm.
\eeqnn
The matrix $T$ is invertible  (det $T = L_s L_r >0$) the reverse transformation is written:
\eqnn
\bpm
x_1 \\x_2 \epm = \bpm \dfrac{1}{L_s} &  0\\ & \vm \\-\dfrac{K_e}{L_sL_r} &
\dfrac{1}{L_r} \epm \bpm z_1\\z_2 \epm.
\eeqnn
In the new coordinates $(z_1,z_2)$, the state model is written:
\begin{equation*} \begin{split} 
\bma{c} \dot z_1 \\ \dot z_2 \ema &= \bma{lcc}-\dfrac{R_s}{L_s} & & 0\\ & & \\
\dfrac{K_e\omega}{L_r} + \dfrac{K_e(R_r+R_L)}{L_r L_s}  - 
\dfrac{K_eR_s}{L^2_s} & & -\dfrac{R_r+R_L}{L_r} \ema \bma{c} z_1\\z_2 \ema \\ & \vspace{-4mm} \\ & \hd +
\bma{c} 1 \\ \vspace{-2mm} \\ \dfrac{K_e}{L_s} \ema u \hspace{8cm} \qed
\end{split} \end{equation*}
\end{exemple} 
\vv

\begin{exemple}{\bf \em Compartments linear model}

We are interested in linear compartments models as described in the section 4.4. Remind that the general form of equations state is:
\eqnn
\dot x_i= \sum^n_{j=1} k_{ji} x_j - \sum^n_{\ell=0} k_{i\ell}x_i +b_iu_i, 
\hspace*{10mm} i = 1,n
\eeqnn
or in matrix form:
\eqnn
\dot x = Ax + Bu
\eeqnn
with $A$ a Metzler’s matrix diagonally dominant and $x_i$ the total amount contained in the compartment $i$. We want express the model in terms of concentrations. We introduce following notations:
\begin{equation*} \begin{split}
V_i &: \mbox{ volume of compartment  } i,\\
a_{ij} &\triangleq  k_{ij} V_i,\\
z_i&= \frac{x_i}{V_i} : \mbox{concentration in the compartment } i.
\end{split} \end{equation*}
With these notations, we can rewrite the model as :
\begin{equation*} \begin{split}
\dot x_i &= \sum^n_{j=1} \frac{a_{ji}}{V_j} x_j - \sum^n_{l=0}\frac{a_{il}}{V_i}x_i + b_i u_i,\\
\dot x_i&= \sum^n_{j=1} a_{ji} z_j -\sum_{\ell=0}^n a_{i\ell} z_i + b_i u_i,
\end{split} \end{equation*}
and therefore :
\eqnn
\dot z_i = \sum^n_{j=1} \frac{a_{ji}}{V_i} z_j - \sum^n_{\ell=0} \frac{a_{i\ell}}{V_i} z_i + \frac{b_i}{V_i} u_i
\eeqnn
We have done a state transformation converting the total amount $x_i$ to concentrations $z_i$ as state variables. In matrix form the state transformation is written:
\eqnn
z = V^{-1}x \mbox{ avec } V \triangleq \mbox{ diag} \{ V_i, i=1, \ldots, n \}
\eeqnn
In the concentration coordinates, the model becomes:
\eqnn
\dot z = Fz + Gu
\eeqnn
with $ F \triangleq V^{-1} AV$ et $ G \triangleq V^{-1} B$.  
We can verify that the matrix $F^T$ is also a Metzler matrix diagonally dominant.  \qed
\end{exemple}
\vv

\begin{exemple}{\bf \em Diagonalisation et constantes temps}

On considère un modèle linéaire $\dot x = Ax +Bu$ dont la matrice $A$ a
 toutes ses valeurs propres $\lambda_i$ réelles, distinctes et non-nulles.  
 Elle est alors diagonalisable, c'est à dire qu'il existe une matrice
  $T$ telle que
\eqnn
D \triangleq TAT^{-1} = \mbox{ diag}(\lambda_i, i=1, n)
\eeqnn
Si on définit une transformation d'état :
\eqnn
z = Tx
\eeqnn
\noindent le système est transformé en :
\eqnn
\dot z = Dz + TBu
\eeqnn
ou, encore composante par composante :
\eqnn
 \dot z_i = \lambda_i z_i + \beta_i u \;\;\;\; i=1,n
\eeqnn
où $\beta_{i}$ est la i-ème ligne de la matrice $TB$. Les grandeurs
$\tau_i = |\lambda_i|^{-1}, i=1,\ldots , n$, sont les {\em constantes de temps du système}.
\begin{figure}[htbp]    \centering
   \includegraphics[height=10cm]{schemadiag} 
   \caption{Schéma fonctionnel d'un système diagonalisé à une entrée}
   \label{Fig:schemadiag}
\end{figure}

We have now operate a state transformation going from total quantities  $x_i$ to concentrations $z_i$ as state variables. In a matrix format the state transformation can be written as :
\eqnn
z = V^{-1}x \mbox{ avec } V \triangleq \mbox{ diag} \{ V_i, i=1, \ldots, n \}
\eeqnn
In the concentration coordinates, the model becomes :
\eqnn
\dot z = Fz + Gu
\eeqnn
with $ F \triangleq V^{-1} AV$ et $ G \triangleq V^{-1} B$.  
We can check that the matrix $F^T$ is also a diagonally dominant Metzler matrix.  \qed
\end{exemple}
\vv

\begin{exemple}{\bf \em Diagonalization and time constants}

Let us consider a linear model $\dot x = Ax +Bu$ in which the eigen values $\lambda_i$ of the matrix $A$ are real, distinct and non-zero. Then the matrix $A$ is diagonalizable, which means there is a matrix $T$ such that
\eqnn
D \triangleq TAT^{-1} = \mbox{ diag}(\lambda_i, i=1, n)
\eeqnn
If we define a state transformation :
\eqnn
z = Tx
\eeqnn
\noindent The system is then transformed into :
\eqnn
\dot z = Dz + TBu
\eeqnn
or, components by components : 
\eqnn
 \dot z_i = \lambda_i z_i + \beta_i u \;\;\;\; i=1,n
\eeqnn
where $\beta_{i}$ is the i-th row of the matrix $TB$. The parameters
$\tau_i = |\lambda_i|^{-1}, i=1,\ldots , n$, are the {\em time constants of this system}.
\begin{figure}[htbp]    \centering
   \includegraphics[height=10cm]{schemadiag} 
   \caption{Block diagram of a diagonalized system with one entry}
   \label{Fig:schemadiag}
\end{figure}

We have now replaced the initial model in which the state variables can be strongly related by a collection of first-order systems completely separated from each other as we can see on the block diagram illustrated in figure \ref{Fig:schemadiag}.

For instance let us consider a DC motor controlled by the stator (see chapter 3, section 3.6) with $h(\omega) = B\omega$~:
\eqnn
\dfrac{d}{dt} \bma{c} I_s\\ \omega\ema = \bma{cc}-\dfrac{R_s}{L_s}& 0\\ & \vm \\
\dfrac{K_mI_r}{J} & -\dfrac{B}{J} \ema  \bma{c} I_s\\ \omega\ema +
\bma{c}\dfrac{1}{L_s}u_1\\ \vm \\ \dfrac{1}{J} u_2 \ema,
\eeqnn
we check that time constants are  
\begin{equation*} \begin{split}
 \tau_e &= \dfrac{L_s}{R_s}  \text{ electric time constant},\\
\tau_m &= \dfrac{J}{B} \text{ mechanical time constant}. \xqedhere{3.5cm}{\qed} 
\end{split} \end{equation*}
\end{exemple}
\vv

\begin{exemple}{\bf \em Reaction systems as multi-compartment systems}

In chapter 5, we have seen that the state model for reaction systems can be written as
\eqnn 
\dot x =  Cr(x) + q_{in}(x,u) - q_{out}(x,u).  
\eeqnn
Let us introduce the following notations for entry and output vectors :
\begin{equation*} \begin{split}
q_{in}(x,u) &\teq \Big(q_{o1}(x,u), q_{o2}(x,u), \hdots , q_{on}(x,u)\Big)^T, \\
q_{out}(x,u) &\teq \Big(q_{1o}(x,u), q_{2o}(x,u), \hdots , q_{no}(x,u)\Big)^T.
\end{split} \end{equation*}
Let us now suppose that the system is conservative and that the flows $q_{oi}$ and $q_{io}$ meet the conditions C1, C2 and C3 form chapter 4.
Then the reaction system is equivalent to a multi-compartments system with the following linear state transformation :
\eqnn
z = T x, \hd T \teq \textrm{ diag} \{ \omega_2, \omega_2, \hdots , \omega_n \}.
\eeqnn
To illustrate that property, let us consider again the example of the perfectly mixed chemical reactor (see example 5.6). In that reactor, the two reactions 
\begin{equation} \begin{split} \label{exa}
X_1 + X_2 \; &\longrightarrow \; 2X_3, \\ 
2X_3 \; &\longrightarrow \; X_4 
\end{split} \end{equation}
occur simultaneously in the liquid phase with kinetics 
\begin{equation} \begin{split} 
r_1(x) &= k_1x_1x_2e^{-(Kx_4)}, \\
r_2(x) &= k_2x_3^2. 
\end{split} \end{equation}
The reactor is fed by the two initial reactives $X_1$ and $X_2$ in solution with feeding concentrations $x_1^{in}$ and $x_2^{in}$.

The state model can be written as 
\eqnn
\bpm \dot x_1 \\ \dot x_2 \\ \dot x_3 \\ \dot x_4 \epm =
\bpm -1 & 0 \\ -1 & 0 \\ 2 & -2 \\ 0 & 1 \epm \bpm
k_1x_1x_2e^{-(Kx_4)} \\ k_2x_3^2 \epm 
 + u \bpm x_1^{in} -x_1 \\ x_2^{in} -x_2 \\ -x_3 \\ -x_4
\epm   
\eeqnn
where the state variables $x_1, x_2, x_3$ and $x_4$ represents the species concentrations in the reaction medium.

We can easily check that the system is conservative with the normalization vector $\omega = (1,1,1, 2)$. Thus, we define the linear state transformation 
\eqnn
z_1 = x_1, \hd z_2 = x_2, \hd z_3 = x_3, \hd z_4 = 2x_4.
\eeqnn
In those new coordinates, we obtain a multi-compartments system of which the graph is illustrated in figure \ref{reacompart} and of which the state model is :
\eqnn
\bpm \dot z_1 \\ \dot z_2 \\ \dot z_3 \\ \dot z_4 \epm = \bpm -k_1 z_2 \varphi - u & 0 & 0 & 0 \\ 0 & -k_1 z_1 \varphi - u & 0 & 0 \\ k_1 z_2 \varphi & k_1 z_1 \varphi & -2 k_2 z_3 - u & 0 \\ 0 & 0 & 2 k_2 z_3 & -u \epm \bpm z_1 \\ z_2 \\ z_3 \\ z_4 \epm + \bpm u x_1^{in} \\ u x_2^{in} \\ 0 \\ 0 \epm 
\eeqnn
with
\eqnn
 \varphi \teq \exp(- \dfrac{K}{2} z_4). \xqedhere{5cm}{\qed}
\eeqnn

\end{exemple}
\begin{figure}[tbp] 
   \centering
   \includegraphics[height=30mm]{reacompart} 
   \caption{Compartment representation of a reaction system}
   \label{reacompart}
\end{figure}

\section{Non-linear state transformations}

For a non-linear state model $\dot x = f(x,u)$, it is often more interesting to consider non-linear state transformations. However it is generally not possible to define {\em global} transformations that are valid for every $x \in \real^n$. We are then interested in {\em local} transformations that are defined in a susbset of $\real^n$.

\begin{definition}{\bf \em Non-linear state transformation}

Let $U$ and $V$ be two open subset of $\real^n$. A non-linear state transformation is an application  $T : U \rightarrow V$ that transforms the state of the system $x \in U$ in a new state $z \in V$ :
$$
z = T(x)
$$
and that possess the following properties :
\begin{enumerate}
\item[a)] the application $T$ is bijective, which means that there is an inverse function $T^{-1} : V \rightarrow U$ such that $x = T^{-1} (z)$,
\item[b)] $T(x)$ ans $T^{-1}(z)$ are functions of class $C^{1}$, that is to say continuous and differentiable.
\end{enumerate}
\noindent The state transformation is said to be {\em global} if $U=V=\real^n$. \qed
\end{definition}

A transformation $T$ possessing those properties is called a diffeomorphism. Its bijectivity is necessary to reverse the state variables change and to go back to the initial state variables.
The property b)  ($T$ and $T^{-1}$ are of classes $C^1$) is necessary to express the state model in the new coordinates as follows :
$$
\dot z = \frac{\partial T}{\partial x} \dot x = \frac{\partial
T}{\partial x} f(x, u)
$$
where, by using $x = T^{-1}(z)$, we obtain
$$
\dot z = g(z,u)
$$
with :
\begin{equation*} \begin{split} 
g(z,u) \triangleq \left[ \frac{\partial T}{\partial x}
f(x,u)\right ]_{x = T^{-1}(z)}.
\end{split} \end{equation*}
In a similar way, we can express :
$$
f(x,u) \triangleq \left[\frac{\partial T^{-1}}{\partial z}
g(z,u)\right ]_{z = T(x)}
$$
The properties given in the following lemma can be useful to demonstrate the existence of a non-linear state transformation. 
\begin{lemme}{\blanc}
\begin{enumerate}
\item If the jacobian matrix $[\partial T/\partial x]$ is non-singular at $x_0$, then, by the inverse funtction theorem, there is a neighborhood $U$ around $x_0$ such that the application $T$ restricted to $U$ is a diffeomorphism on $U$.
\item $T$ is a global diffeomorphism if and only if~:
\begin{itemize}
\item[a)] $[\partial T/\partial x]$ is non-singular for every $x$ in $\real^n$;
\item[b)] $\lim_{\|x\|\rightarrow\infty}\|T(x)\| = \infty$. \qed
\end{itemize}
\end{enumerate}
\end{lemme}

\section{Mechanical systems}

As we have seen in chapter 2, the state vector of a mechanical system is made of two parts : the position coordinates $q$ and the speed coordinates
$v=\dot q$
$$ x = \bma{c} q \\ v \ema. $$
In numerous applications, it is interesting to consider different sets of position coordinates. The state transformation is then made through two steps. First we transform the position coordinates :
$$ p = \phi (q)$$
where $\phi : U_1 \rightarrow V_1$ is a diffeomorphism and 
$\partial \phi /\partial q$ is of full rank $\forall q \in U_1$.

The new state vector is then formed by the new position coordinates $p$ and their derivatives $w = \dot p$ :
$$
z = \bma{c} p\\w \ema.
$$
The state transformation is then defined as follows :
\begin{equation*} \begin{split}
 z = T(x), \hspace*{10mm} \bma{c}p\\w  \ema = \bma{c} \phi(q)\\
\dfrac{\partial \phi}{\partial q} v \ema.
\end{split} \end{equation*}
The inverse state transformation is :
$$
x=T^{-1}(z), \hd \bma{c}q\\v \ema = \bma{l} \phi^{-1}(p) \\
\left(\dfrac{\partial \phi}{\partial q}\right )^{-1}_{q = \phi^{-1} p}w
\ema.
$$

\begin{exemple}{\bf \em Polar and cartesian coordinates}

In the method described in chapter 2 to establish a state model for articulate mechanical systems, the position of each body's center of mass is given by its cartesian coordinates $q =(x,y)$, as showed on the figure \ref{Fig:cocarpol}.
\begin{figure}[htbp] 
   \centering
   \includegraphics[width=6cm]{cocarpol} 
   \caption{Cartesian coordinates and polar coordinates}
   \label{Fig:cocarpol}
\end{figure}
Another set of frequently used coordinates are the polar coordinates $r$ and $\alpha$ : $r$ is the distance between the origin and the center of mass and $\alpha$ is the angle between the axis $OX_b$ and the vector $\small \overrightarrow{OG}$.

The transformation allowing to go from cartesian coordinates to polar coordinates can be written as :
\begin{equation*} \begin{split}
&q = \bma{c} x \\y \ema \;\;\; p = \bma{c} r\\ \alpha \ema,\\
& \vm \\
&p = \phi(q) : \left\{ \begin{array}{ll}
r =&\sqrt{x^2 + y^2},\\ 
\alpha  =&\mbox{arc} \sin \dfrac{y}{\sqrt{x^2 + y^2}} 
\end{array}
\right..
\end{split} \end{equation*} 
The inverse transformation $q = \phi^{-1} (p) $ is written :
\begin{equation*} \begin{split}
x &= r \cos \alpha,\\
y &= r \sin \alpha.
\end{split} \end{equation*}
We notice that the change of coordinates $p = \phi(q)$ is not defined at the origin, that is when $x=0$ and $y=0$.  We also check taht
$$ \det[\frac{\partial \phi^{-1}}{\partial p} ] = r
$$
is zero when $r=0$ (which is the origin also). It follows that the tranformation of coordinates is not global but only valid on the following sets :
\begin{equation*} \begin{split}
U_1 &=\real^2 \backslash \{(0,0)\},\\
V_1 &= \real^2 \backslash \{(r, \alpha) : r = 0\}.
\end{split} \end{equation*}
Finally, the complete state transformation between the state 
$(q,v)$ and the state $(p,w)$ is written as follows :
\begin{equation*} \begin{split}
r&= \sqrt{x^2 +y^2},\\
\alpha &= \mbox{arc} \sin \frac{y}{\sqrt{x^2 +y^2}},\\
\dot r &= \frac{x \dot x + y \dot y}{\sqrt{x^2 +y^2}},\\
\dot \alpha &= \frac{x \dot y - \dot x y}{x^2 + y^2},
\end{split} \end{equation*}
and the inverse transformation :
\begin{equation*} \begin{split}
x&= r \cos \alpha,\\
y &= r \sin \alpha,\\
\dot x &= \dot r \cos \alpha - r \dot \alpha \sin \alpha,\\
\dot y &= \dot r \sin \alpha + r \dot \alpha \cos \alpha. \xqedhere{4.6cm}{\qed}
\end{split} \end{equation*}
\end{exemple}

\begin{exemple}{\bf \em Articular coordinates and robotic task coordinates}

For manipulator robots consisting of as many actuators as degrees of freedom, with rotoïd joints, articular coordinates from chapter 2 are \gf natural \gf coordinates for the description of the system : every coordinate gives the position of an arm compared to the previous one.
Generally, with those coordinates, the model becomes quite simple. The articular models are adequate for the conception of systems designed to control robots.

On the point of view of the user, interested for instance by planning trajectories, the task coordinates, that is the coordinates of the effector, are more interesting. Let us consider for instance a planar robot with two degrees of freedom moving in a horizontal plane (see figure \ref{Fig:robplan}).
\begin{figure}[htbp]
   \centering
   \includegraphics[width=6cm]{robplan} 
   \caption{Articular coordinates and task coordinate for a robot with two degrees of freedom.}
   \label{Fig:robplan}
\end{figure}
The articular coordinates are the angles $\alpha_1$ and $\alpha_2$, the tasks coordinates are the cartesian coordinates $X$ and $Y$.
Then we have : 
$q = (\alpha_1, \alpha_2)$ et $p = \phi(q) = (X,Y)$.  The transformation allowing to go from articular coordinates to task coordinates are written 
\eqn
 X &=& l_1 \cos \alpha_1 + l_2 \cos(\alpha_1 + \alpha_2)\label{artache1},\\
 Y &= &l_1 \sin\alpha_1 + l_2 \sin(\alpha_1 + \alpha_2)\label{artache}.
\eeqn
\noindent We easily check that this transformation can not be injective : a position $(X,Y)$ of the effector corresponds to two distinct and symmetrical positions of the robot. To correctly define a transformation of coordinates, we must define the domains $U$ and $V$ corresponding to the application $\phi$ and its inverse.

We first observe that the image of the application $\phi$ is necessarily restricted to the circle of accessible positions for the robot, that is (if $l_2 > l_1)$ a circle of radius $l_1 + l_2$ :
$$ 
V_1 \triangleq \{(X,Y) : (l_2 - l_1)^2 < X^2 + Y^2 < (l_1 + l_2)^2 \}.
$$
On the other hand, the domain of $\phi$ must be chosen so the application is injective. A possible choice is the following :
$$
U_1 \triangleq \{(\alpha_1, \alpha_2) : -\pi < \alpha_1 < \pi \;\;\; 0 <
\alpha_2 < \pi\}.
$$
With those definitions, we can check that the application 
$$
\phi : U \longrightarrow V
$$
defined by the equations (\ref{artache1})-(\ref{artache}) is a diffeomorphism.

Then we need to complete the transformation to extend it to the speed coordinates. The state vectors written in articular coordinates and in task coordinates are defined as follows : 
$$
x^T = (\alpha_1, \alpha_2, \dot \alpha_1, \dot\alpha_2), \hspace*{10mm} z^T
= (X,Y,\dot X, \dot Y).
$$
The state transformation $z = T(x)$ can finally be written as :
\begin{equation*} \begin{split}
X &= l_1 \cos\alpha_1 + l_2 \cos(\alpha_1 + \alpha_2),\\
Y&= l_1 \sin\alpha_1 + l_2 \sin(\alpha_1 + \alpha_2,\\
\dot X &=-l_1 \dot \alpha_1\sin\alpha_1 -l_2 \dot \alpha_1\sin(\alpha_1+\alpha_2) - l_2 \dot \alpha_2\sin(\alpha_1 + \alpha_2),\\
\dot Y &= l_1 \dot \alpha_1\cos\alpha_1 + l_2 \dot \alpha_1\cos(\alpha_1+\alpha_2) + l_2 \dot \alpha_2\cos(\alpha_1 + \alpha_2). \xqedhere{1.8cm}{\qed}
\end{split} \end{equation*}
\end{exemple}

\section{Electrical machines}

In chapter 3, we have obtained a general model for rotating electrical machines of the form :
\begin{equation*} \begin{split}
L(\theta) \dot I &= -\omega K(\theta) I - RI +V, \\
\dot\theta &= \omega, \label{machel}\\
J \dot \omega &= \frac{1}{2}I^TK(\theta)I - h(\omega) + T_a, 
\end{split} \end{equation*}
with
$$
K(\theta)\triangleq\frac{\partial L(\theta)}{\partial \theta}.
$$
These equations naturally lead to establish state models in which the state vector
$$
x^T = (I^T, \theta, \omega)
$$
is made of currents $I$, angular position $\theta$ and angular speed $\omega$.  Other choices of state variables can be used to ease the mathematical study of electrical machines. A current transformation consists of replacing currents by flows :
$$
\phi = L(\theta)I,
$$
that is transforming the state vector $x^T = (I^T, \theta, \omega)$ into the state vector $z^T = (\phi^T, \theta, \omega)$. This transformation is actually a diffeomorphism because the inductance matrix 
$L(\theta)$ is invertible for all $\theta$.

In the new state variables $z$, the equations (\ref{machel}) can be written : 
\begin{equation*} \begin{split}
\dot\phi &= -RL^{-1}(\theta)\phi+ V,\\
\dot \theta &= \omega,\\
J\dot\omega &= \dfrac{1}{2} \phi^T G(\theta) \phi - h(\omega) + T_a,\\
\mbox{ avec } G(\theta) &\triangleq  L^{-1}(\theta)K(\theta)L^{-1}(\theta).
\end{split} \end{equation*}
\vv

\section{Triangular systems} \label{triangulaire}
 
 A system with {\it only one} entry (mono-entry system)
 \eqn
 \dot x = f(x,u) \hh \hh x \in \real^n \hh \hh u \in \real \label{mono}
 \eeqn
is said to be {\it triangular} if it meets the following definition.

\begin{definition}{\bf \emph Triangular system}

A dynamic mono-entry system is triangular if there is a state variable $x_i$ such that the shortest path from $u$ to $x_i$ in the system's graph is of length $n$. \qed
\end{definition}

For a triangular system, it is therefore always possible to renumber the state variable such that the state model can be written as :
\begin{equation} \begin{split} \label{systriang}
\dot x_1 &= g_1(x_1,x_2),  \\
\dot x_2 &= g_2(x_1,x_2, x_3),  \\
&\vdots  \\
\dot x_i &= g_i(x_1,x_2, \dots ,x_{i+1}),  \\
&\vdots  \\
\dot x_{n-1} &= g_{n-1}(x_1,x_2, \dots ,x_n),  \\
\dot x_n &= g_n(x_1,x_2, \dots ,x_n,u).  
\end{split} \end{equation}
We observe that the number of state variables on the right increases progressively from $2$ to $n$ (which is why it's called a triangular form). Besides, the entry $u$ appears only in the last equation.
\vv

\begin{exemple}{\bf \em Manipulative robot with one degree of freedom and an elastic joint \label{exrobot}}

The state model of such a robot with an elastic rotoid joint and negligeable friction torques can be written as:
\begin{equation} \begin{split} \label{robotelast}
\dot x_1 &= x_2,  \\
J_1\dot x_2 &= -mgd\sin x_1 - k(x_1 - x_3),  \\
\dot x_3 &= x_4,  \\
J_2\dot x_4 &= k(x_1 - x_3) + u.
\end{split} \end{equation}
where

$x_1$ is the angular position coordinate of the arm,

$x_2$ is the angular speed of the arm,

$x_3$ is the angular position coordinate of the motor,

$x_4$ is the angular speed of the motor,

$J_1$ and $J_2$ are the inertia momentum of the arm and the motor,

$d$ is the distance between the joint and the center of mass,

$k$ is the elastic spring constant ,

$u$ is the commanded torque developped by the motor.\\

\noindent The graph of the system is represented on figure
\ref{Fig:grafrobot} and we can check that the state equations have the wanted triangular structure. \qed
\begin{figure}[htbp]
   \centering
   \includegraphics[width=9cm]{grafrobot} 
   \caption{Graph of the model of a single arm robot with an elastic joint.}
   \label{Fig:grafrobot}
\end{figure}
\end{exemple}

\section{Brunovski canonical form}\label{sectionbrunovski}

\begin{definition}{\blanc}

A dynamic mono-entry system (\ref{mono}) can be written under the Brunovski canonical form if there is a state transformation $ T : U \rightarrow V$ and an open interval $W \subset \real$ 
  such that, in the new state variables $z=T(x)$, the system takes on the following particular triangular form:
 \begin{equation*} \begin{split}
 \dot z_1 &= z_2,\\
 \dot z_2 &= z_3,\\
 \vdots &\\
 \dot z_n &= \alpha (z_1, z_2, \ldots, z_n, u),
\end{split} \end{equation*}
where the function $\alpha$ is continuous and invertible according to $u$ over $W$ for all $z \in V$.
\qed
\end{definition}

 We observe that the system is therefore made of a chain of integrators such that
 \begin{equation*} \begin{split}
 \dot z_i = z_{i+1}\;\;\; i = 1. \ldots, n-1
 \end{split} \end{equation*}
 and that all system non-linearities are focused on the only non-linear scalar function $\alpha (z_1, z_2, \ldots, z_n, u)$.  The Brunovski canonical form can also be schematized as indicated on figure \ref{Fig:bruno}. The Brunovski form is interesting because it allows to easily plan trajectories as we will see in chapter 10.
  \begin{figure}[htbp] 
    \centering
    \includegraphics[width=9cm]{bruno} 
    \caption{Functionnal schem of Brunovski cannonical form}
    \label{Fig:bruno}
 \end{figure}
 
\begin{exemple}{\bf \em A chemical reactor \label{exreachim} }
 
Let us consider a perfectly mixed continuous reactor with constant volume in which occurs an irreversible chemical reaction using two species $X_1$ and $X_2$ :
 $$
 X_1 \longrightarrow X_2.
 $$
 The reactor is only fuelled with $X_1$, with constant concentration
 $c$.  The input variable is the specific volumetric input flow rate of the reactor. The kinetics obeys the law of mass action. According to the modelisation principles established in chapter 5, we get a bilinear state model :
 \begin{equation*} \begin{split}
 \dot x_1 &= -kx_1 + u (c-x_1),\\
 \dot x_2 &= kx_1 - ux_2.
 \end{split} \end{equation*}
 We define the following state transformation $z = T(x)$ :
 \begin{equation*} \begin{split}
 z_1 &= \frac{x_2}{c-x_1},\\
 z_2 &= \frac{kx_1(c-x_1-x_2)}{(c-x_1)^2}.
 \end{split} \end{equation*}
 The domain $U$ and the image $V$ of the application $T : U \longrightarrow V$
 are defined according to :
 \begin{equation*} \begin{split}
 U &= \{(x_1, x_2) : x_1 > 0, x_2 > 0, x_1+x_2 < c \},\\
 V &= \{(z_1,z_2) : 0<z_1 <1, z_2>0 \}.
 \end{split} \end{equation*}
We can then show that the state transformation $z = T(x)$ hereby defined is a diffeomorphism and its inverse is :
 \begin{equation*} \begin{split} 
 x_1 &= \frac{cz_2}{k(1-z_1)+z_2},\\
 x_2 &= \frac{ckz_1(1-z_1)}{k(1-z_1)+z_2}.
 \end{split} \end{equation*}
 In the new coordinates, the state model is under Brunovski cannonical form :
 \begin{equation*} \begin{split} 
 \dot z_1 &= z_2,\\
 \dot z_2 &= -\left( z_2 + \dfrac{(k+1)z^2_2}{k(1-z_1)} \right) + (k(1-z_1) + z_2)u.
 \end{split} \end{equation*} 
The function $\alpha$ is invertible according to $u$ over $W$. \qed
\end{exemple}

This example shows that it is difficult to determine \textit{a priori} if a given dynamic system can be put under Brunovski form and to find the appropriate state transform. However, if the system is already given in a triangular form, here is a sufficient condition to put it in the Brunovski form :
\begin{lemme}{\blanc} \label{lemmeici}

A triangular dynamic system  described by the state model (\ref{systriang}) can be put under Brunovski cannonical form around $(x_0,u_0)$ if the following inegalities :
\begin{equation*} \begin{split}
\frac{\partial g_i}{\partial x_{i+1}} &\neq 0 \hh \hh i=1, \ldots, n-1, \\
\frac{\partial g_n}{\partial u} &\neq 0,
\end{split} \end{equation*}
are satisfied in $(x_0,u_0)$.
\qed
\end{lemme}
\vv

\begin{exemple}{\bf \em Manipulative robot with one degree of freedom and an elastic joint (continued)}

Let us consider again the model (\ref{robotelast}) of the example \ref{exrobot}. We easily check that the conditions of the Lemma \ref{lemmeici} are satisfied for all $x \in \real^4$ and naturally lead to the state transformation :
\begin{equation*} \begin{split} 
z_1 &= x_1 \\
z_2 &= x_2 \\
z_3 &= -J_1^{-1}[mgd\sin x_1 + k(x_1 -x_3)] \\
z_4 &= -J_2^{-1}[mgdx_2 \cos x_1 + k(x_2 - x_4)].
\end{split} \end{equation*}
The inverse state transformation is written as :
\begin{equation*} \begin{split} 
x_1 &= z_1 \\
x_2 &= z_2 \\
x_3 &= (mgdk^{-1} \sin z_1 + z_1 + J_1k^{-1}z_3) \\
x_4 &= (mgdk^{-1} z_2 \cos z_1 + z_2 + J_2k^{-1}z_4) 
\end{split} \end{equation*}
We observe that there is a global diffeomorphism $\real^4$  in $\real^4$. With the new state variables, the model is written following the Brunovski form:
\begin{equation*} \begin{split} 
\dot z_1 &= z_2 \\
\dot z_2 &= z_3 \\
\dot z_3 &= z_4 \\
\dot z_4 &= J_2^{-1}[mgd(z_2^2 \sin z_1 - z_3 \cos z_1) -k z_3] \\ & \hh \hh + kJ_2^{-2}[mgd\sin z_1 + J_1z_3 - u]
\end{split} \end{equation*}
We also observe that the function $\alpha$ is always invertible on $\real$ with respect to $u$. The Brunovski form is thus overall valid.
\qed
\end{exemple}
 
 For control-affine system that are not triangular, the following lemma gives usefull conditions to find the state transformation.
\begin{lemme}{\blanc}
A control-affine system
$$
\dot x = f(x) + g(x)u \hh \hh x \in \real^n \hh \hh u \in \real
$$
can be put in Brunovski form in a domain $U \subset \real^n$ if there exists a state transformation $z = T(x)$ that verify the following conditions~:
\begin{equation*} \begin{split} 
& T_{i+1}(x) = \frac{\partial T_i}{\partial x}f(x) \hh \hh i=1,2, \ldots, n-1, \\
& \frac{\partial T_i}{\partial x}g(x) = 0 \hh \hh i=1,2, \ldots, n-1, \\
& \frac{\partial T_n}{\partial x}g(x) \neq 0,
\end{split} \end{equation*}
for every $x \in U$. \qed
\end{lemme}
\vv

\begin{exemple}{\bf \em A chemical reacor (continuation) }
We show here how to use the previous lemma to find the state transformation that has been given in the exemple
 \ref{exreachim}. The model can be written:
\begin{equation*} \begin{split}
\bma{c} \dot x_1 \\ \dot x_2 \ema = \bma{c} -x_1 \\ x_1 \ema + \bma{c} c-x_1 \\ -x_2 \ema u \triangleq f(x) + g(x)u
\end{split} \end{equation*}
First of all we consider the following partial differential equation.
\begin{equation*} \begin{split}
\frac{\partial T_1}{\partial x}g(x)=0 \hh \Rightarrow \hh \frac{\partial T_1}{\partial x_1}(c-x_1) = \frac{\partial T_1}{\partial x_2}x_2
\end{split} \end{equation*}
This equation admits the following solution:
\begin{equation*} \begin{split}
T_1(x) = \frac{x_2}{c-x_1}
\end{split} \end{equation*}
We calculate then:
\begin{equation*} \begin{split}
T_2(x) = \frac{\partial T_1}{\partial x}f(x) \hh \Rightarrow \hh T_2(x) = \frac{kx_1(c-x_1-x_2)}{(c-x_1)^2}
\end{split} \end{equation*}
We determine the domain  $U$ and the image $V$ of the so defined application $T:U \rightarrow V$. At last, we check that the condition $(\partial T_2/\partial x)g(x) \neq 0$ is satisfied everywhere on $U$~:
\begin{equation*} \begin{split}
\frac{\partial T_2}{\partial x}g(x) = \frac{c(c-x_1-x_2)}{(c-x_1)^2} \neq 0 \xqedhere{3.9cm}{\qed}
\end{split} \end{equation*}
\end{exemple}

\section{Exercices}

\begin{exercice}{\bf \em A glass melting oven}

In chapter 1, Exemple 1.1 and Exercice 1.1, we have introduced three different sets of state variables for a model of glass melting furnace. 
Determine the three corresponding state transformations and give their definition domain. \qed

\end{exercice}
\vv


\begin{exercice}{\bf \em An electromagnetic relay}

We consider the electromagnetic relay which state model has been given in Chapter 3, Exemple 3.2.
\begin{enumerate}
\item We choose the new following state variables: $y_1 = z$, $y_2 = \dot z$, $y_3 = \phi(I,z)$. Show that it is a valid state transformation. Give the state model expressed with these new variables.
\item Show that the system can be put in Brunovski canonical form. Determine the state transformations and give a physical interpretation of the state variables. \qed
\end{enumerate}
\end{exercice}
\vv

\begin{exercice}{\bf \em An elevator shaft}

\begin{tabular}{p{6.5cm}p{2mm}c}
\vspace{-3.2cm} 
On the beside figure, we represented an elevator shaft that hangs from an elastic cable of negligible mass.
\vspace{2mm}

\noindent {\bf Notations:}

$y$ = length of the cable

$\omega$ = angular velocity of the pulley

$R$ = radius of the pulley

$m$ = mass of the elevator shaft

\vspace{2mm}
\noindent The force in the cable is modeled by the Hooke's law:
\begin{equation*}
T = \frac{k(y - z)}{z}
\end{equation*}
where $z$ is an auxiliary state variable. The derivative of $z$ is the peripheral speed of the pulley: $\dot z = R \omega$.
& &
\parbox[c]{6cm}
{\includegraphics[width=4.5cm]{ascenseur.pdf}}
\end{tabular}

\begin{enumerate}
\item Find a state model with 4 state variables: $y, \dot y, z, \omega$. We assume the friction is negligible. The input variable is the  torque $u$ applied at the pulley.
\item Show that the system can be put in Brunovski form. Give the state transformation. \qed
\end{enumerate}
\end{exercice}
\vv

\begin{exercice}{\bf \em Ladybugs and aphids}

Show that there exists a state transformation such that the system (\ref{coc}) in chapter 1 describing the interaction between the ladybug and aphid populations can be put in the form of a compartment system. Draw the associated graph. Determine the flows $q_{ij}$, the matrix $L$ and the matrix   $A(x,u)$. \qed
\end{exercice}
\vv

\begin{exercice}{{\bf \em A biochemical reactor}}

Let's consider a continuous stirred tank reactor at constant volume. In this reactor, there is an irreversible autocatalytic reaction with two species 
 $A$ and $B$:
\e
A + B \longrightarrow 2B
\ee
The reactor is only supplied with the species $A$, at constant concentration. The input variable is the volumetric feed flow of the reactor. Kinetics follows the law of mass action.

\begin{enumerate}
\item Give the equations of the state system.
\item Show that the system is conservative.
\item Determine a state transformation which put the system in Brunovski canonical form.
\item Determine the state transformation which put the system in compartment system form.
\item Same questions if the reaction is reversible . \qed
\end{enumerate}
\end{exercice}
\vv

\begin{exercice}{\bf An electric oven}

An electric oven is heated by a thermistor as mentionned on the figure below.
\begin{figure}[h]
\begin{center}
\includegraphics[width=8cm]{four}
\label{four}
\end{center}
\vspace{-5mm}
\end{figure}
\begin{enumerate}
\item Develop a state model of the system with the following modelisation assumptions: 
\begin{itemize}
\item[a)] The thermistor is an electrical resistance. Its value depend on the remperature according to the Reinhart-Hart's law:
\begin{equation*}
\dfrac{1}{T} = a + b \ln R + c (\ln R)^3
\end{equation*}
where $a, b, c$ are constants given by the manufacturer.
\item [b)] As shown on the figure, the thermistor is powered by a battery of constant voltage $E$ through a constant inductance (linear)  and 
an adjustable linear resistance which is the input of the system.
\item[c)] The oven is heated by the thermistor. The heat which is lost through the wall of the oven is proportionnal to the difference between the inside temperature and the outside temperature. The outside temperature is supposed to be constant.
\end{itemize}
\item Show that the system can be put in Brunovski form. Give the state transformation. \qed
\end{enumerate}
\end{exercice}
\vv

\begin{exercice}{\bf \em A two-compartment system}

We consider a linear system with two compartments. The graph is given on  (figure  \ref{Fig:deuxcomp}).
Determine the state transformation diagonalizing the system. Give the time constant. \qed
\begin{figure}[h] 
   \centering
   \includegraphics[width=6cm]{deuxcomp} 
   \caption{Graph of a system with two compartments.}
   \label{Fig:deuxcomp}
\end{figure}
\end{exercice}

\end{document}
